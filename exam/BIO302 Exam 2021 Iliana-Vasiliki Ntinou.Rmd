---
title: "BIO302 Exam 2021"
author: "Iliana Vasiliki Ntinou"
date: "6/9/2021"
output: html_document
bibliography: bibliography.bibtex
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Answers

### 6) Model the relationship between total plant biomass in alpine grasslands and summer air temperature in China. Available data are biomass per species per plot. There are \~15 plots in each of four sites. Each site is at a different elevation and has a climate logger.

-   Climate data can be downloaded from <https://osf.io/34qnr/>. Biomass data can be downloaded from <https://osf.io/6sfqw/>.

```{r, message=FALSE}
#1st step is to load libraries
library(here)
library(readxl) 
library(tidyverse)
library(nlme)
library(lubridate)
library(qqplotr)
library(report)
library(see)
library(JWileymisc)
library(MASS)
library(AICcmodavg)
```

```{r, warning=FALSE, message=FALSE}
# 2nd step is to import the climate data which are in csv format. 

url = "https://osf.io/34qnr/download"

download.file (url, "China_2013_2016_AirTemp_month.csv")

climate.df <- read_csv(here("exam/China_2013_2016_AirTemp_month.csv"))


#3rd step is to import the biomass data which are in excel format. The biomass data can be attained from this https://osf.io/6sfqw/ url but it's best to download it manually and save it in the working folder so that all sheets are saved in the same file. 

biomass.df <- excel_sheets(path = "biomass2015.xls") %>% 

                map_dfr(~read_excel(path = "biomass2015.xls", sheet =.x))
```

-   Calculate mean summer air temperatures each site. Use the logger "gradient". The OTC logger is part of another experiment.

```{r, message=FALSE}
climate <- climate.df %>% 
                    #convert the date so it is easier to choose the summer months
                    mutate(date= ymd(month)) %>% 
                    #set site as factor
                    mutate(site = as.factor(site)) %>% 
                    #we need to filter the data to include only summer months and gradient logger  
                    filter(month(date)>05, month(date)<09, logger=="gradient") %>% 
                    #group the values by site  
                    group_by(site) %>%  
                    #calculate the mean temperature
                    summarise(meansummertemp=mean(value, na.rm=T))

```

If we were interested to look at how the mean summer air temperature of 2015 affected that years biomass then we would select the data only from 2015. That could be done as presented below:

```{r}
climate2015 <-climate.df %>% 
              mutate(date= ymd(month)) %>% 
              mutate(site = as.factor(site)) %>% 
              #we need to filter the data to include only summer months of 2015
              filter(month(date)>05, month(date)<09, year(date)==2015, logger=="gradient") %>%  
              group_by(site) %>% 
              summarise(meansummertemp=mean(value, na.rm=T))
```

In this case we choose to continue with the overall mean summer air temperature from data taken from all the years in the dataset.Here the question is to model the relationship between biomass and mean summer air temperature. Having data from many years would give us a better picture of what the mean summer air temperature is in a place, because it could for example happen that one year there was an unusual phenomenon that led to the mean temperature of that year being an extreme.In the latter case, we would be examining whether that phenomenon that affected that years temperature is related to that year's production.

-   Calculate biomass per plot.

```{r, message=FALSE}
biomass <- biomass.df %>%
              #choose columns we are interested in
              dplyr::select(c(site,plot, production)) %>% 
              #set site as factor
              mutate(site = as.factor(site), 
                     # set plot as factor
                     plot= as.factor(plot)) %>% 
              group_by(site, plot) %>% 
              # calculate total biomass per plot
              summarise(biomass = sum(production, na.rm = T))
```

-   Join the climate data to the biomass data.

```{r}
#take all rows from biomass and matching rows from climate
bc <- left_join(biomass,climate, by="site")%>%
      dplyr::select(c(site,biomass, meansummertemp))
```

-   Choose and fit a suitable model to find the relation a biomass and mean summer temperature.

Firstly, we can check for any strong correlations between the variables in our dataset.
```{r, warning=FALSE, message=FALSE}
library(GGally)
GGally::ggpairs(bc, cardinality_threshold = 20)
```
Mean summer temperature and site have the strongest correlation. That is expected since we have one value for the temperature per site.

To choose the model we assume the data follow a normal distribution since the response variable (biomass) is continuous. The predictor variable (mean summer temperature) is also continuous, and the data are clustered in four sites. In that case we choose linear mixed effect model with random effect the sites. Since the research question is to find best model that fits the relationship between biomass and temperature, we assume that site is a random factor. In general, if an effect is fixed or random is mainly the decided by the research question or is  decided by the researcher (Schabenberger and Pierce 2001).
```{r, warning=FALSE, message=FALSE}

#First we build a list of candidate models
mods <- list()
    #null model: biomass isn't related to any variable
    mods$fit.lme <- lme(biomass~+1, random=~+1|site, data=bc)
    #linear mixed effect model
    mods$fit0.lme <- lme(biomass~meansummertemp, random=~+1|site, data=bc)
    #linear mixed effect model with weighted variance. We have to account for heteroskedasticity
    #(the   variance for all observations in each site is not the same)
    mods$fit1.lme <- lme(biomass~meansummertemp, random=~+1|site,
                         weights = varIdent(form=~+1|site),data=bc)

#Then we extract the AIC from each model. The best model is the one with the smallest AIC
sapply(mods, AIC)

#Alternatively we can compare the three models with anova.
    #null model: biomass isn't related to any variable
    fit.lme <- lme(biomass~+1, random=~+1|site, data=bc)
    #linear mixed effect model
    fit0.lme <- lme(biomass~meansummertemp, random=~+1|site, data=bc)
    #linear mixed effect model with weighted variance. We have to account for heteroskedasticity
    #(the   variance for all observations in each site is not the same)
    fit1.lme <- lme(biomass~meansummertemp, random=~+1|site,
                         weights = varIdent(form=~+1|site),data=bc)
anova(fit.lme, fit0.lme, fit1.lme)
#The improvement is significant.

#Finally, we calculate the deltaAIC for each model and the AIC weights for each model.
#ΔAIC - difference between the best AIC and AIC of the other models. 
#Best model has a ΔAIC of zero, highest values for worst models.
aictab(mods)
```
We see from the output that fit1.lme has the smallest AIC number and is significantly improving the model.

-   Check the model's assumptions are met.

```{r, message=FALSE}
#Are the residuals well behaved?
#Is the response variable a reasonably linear function of the fitted values?
#Are the errors reasonably close to normally distributed?
performance::check_model(fit1.lme)
```
The model looks ok!

-   Report key statistics from your model in a table or in the text.

```{r, warning=FALSE}
anova(fit1.lme, type="m")
summary(fit1.lme)
report::report(fit1.lme)
```

-   Make a publication quality plot that shows the relationship between biomass and mean summer temperature.

```{r}

p1 <- ggplot(bc, aes( x=meansummertemp, y=biomass, colour=site, fill=site))+
      
      geom_boxplot()+
      
      stat_summary(fun=mean, geom="point", shape=21, size=6)+
      
      ylim(0, 150)+
  
      scale_colour_manual(values= c("#7570B3","#E7298A","#E6AB02", "#A6761D"), 
                          breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland")) +
      
      scale_fill_manual(values= alpha(c("#7570B3","#E7298A","#E6AB02", "#A6761D"), .3), 
                        breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland"))+
      
      ggtitle("Relationship between biomass and mean summer temperature in alpine grasslands")+
      
      labs(x="Mean Summer Temperature (C°)", y="Biomass (g·m)", col="Site", fill="Site")+
      
      theme_classic(base_size=16)+
      
      theme(plot.title = element_text(hjust = 0.41, size=16),
            
      axis.text.x = element_text(colour="black"), 
            
      axis.text.y = element_text(colour="black"), 
            
      legend.text = element_text(colour="black"),   
            
      panel.grid.minor.x= element_blank(), panel.grid.major.x=element_blank(),
            
      panel.grid.minor.y= element_blank(), panel.grid.major.y=element_blank(),
            
      strip.background=element_blank())
p1
```

-   Write the statistical part of the methods and results sections of a manuscript describing the biomass-climate relationship. You should justify your choice of model.

-   Write a biological interpretation of your final model.

# References
