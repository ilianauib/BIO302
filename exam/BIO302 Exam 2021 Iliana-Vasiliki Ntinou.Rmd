---
title: "BIO302 Exam 2021"
author: "Iliana Vasiliki Ntinou"
date: "6/9/2021"
output: html_document
bibliography: bibliography.bibtex
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Answers

### 6) Model the relationship between total plant biomass in alpine grasslands and summer air temperature in China. Available data are biomass per species per plot. There are \~15 plots in each of four sites. Each site is at a different elevation and has a climate logger.

-   Climate data can be downloaded from <https://osf.io/34qnr/>. Biomass data can be downloaded from <https://osf.io/6sfqw/>.

```{r, message=FALSE}
# 1st step is to load libraries
library(here)
library(readxl) 
library(tidyverse)
library(nlme)
library("lubridate") # to convert the dates. It is much easier to manipulate dates with the tools in this library
```

```{r, warning=FALSE, message=FALSE}
# 2nd step is to import the climate data which are in csv format. 

url = "https://osf.io/34qnr/download"

download.file (url, "China_2013_2016_AirTemp_month.csv")

climate.df <- read_csv(here("exam/China_2013_2016_AirTemp_month.csv"))


#3rd step is to import the biomass data which are in excel format. The biomass data can be attained from this https://osf.io/6sfqw/ url but it's best to download it manually and save it in the working folder so tht all sheets are saved in the same file. 

#Then we can import the data.

biomass.df <- excel_sheets(path = "biomass2015.xls") %>% 

                map_dfr(~read_excel(path = "biomass2015.xls", sheet =.x))
```

-   Calculate mean summer air temperatures each site. Use the logger "gradient". The OTC logger is part of another experiment.

```{r, message=FALSE}



climate <- climate.df %>% 
                       mutate(date= ymd(month)) %>% # convert the date so it is easier to choose the summer months
                       mutate(site = as.factor(site)) %>% # set site as factor
                       filter(month(date)>05, month(date)<09, logger=="gradient") %>% # we need to filter the data to include only summer months and logger to use only gradient
                       group_by(site) %>% # group the values by site 
                       summarise(meansummertemp=mean(value, na.rm=T))#calculate the mean temperature

```

If we were interested to look at how the mean summer air temperature of 2015 affected that years biomass then we would select the data only from 2015. That could be done as presented below:

```{r}
climate2015 <-climate.df %>% 
              mutate(date= ymd(month)) %>% 
              mutate(site = as.factor(site)) %>% 
              filter(month(date)>05, month(date)<09, year(date)==2015, logger=="gradient") %>% # we need to filter the data to include only summer months of 2015 
              group_by(site) %>% 
              summarise(meansummertemp=mean(value, na.rm=T))
```

In this case we choose to continue with the overall mean summer air temperature from data taken from all the years in the dataset.Here the question is to model the relationship between biomass and mean summer air temperature. Having data from many years would give us a better picture of what the mean summer air temperature is in a place, because it could for example happen that one year there was an unusual phenomenon that led to the mean temperature of that year being an extreme.In the latter case, we would be examining whether that phenomenon that affected that years temperature is related to that year's production.

-   Calculate biomass per plot.

```{r, message=FALSE}
biomass <- biomass.df %>%
              select(c(site, plot, production)) %>% #choose columns we are interested in
              mutate(site = as.factor(site), # set site as factor
                     plot= as.factor(plot)) %>% # set plot as factor
              group_by(site, plot) %>% 
              summarise(biomass = sum(production, na.rm = T))# calculate total biomass per plot
```

-   Join the climate data to the biomass data.

```{r}
#take all rows from biomass and matching rows from climate.bc.df <- left_join(biomass,climate, by="site")
bc <- left_join(biomass,climate, by="site") 

#take all rows from biomass and matching rows from climate.bc.df <- left_join(biomass,climate, by="site")
bc.df <- left_join(biomass,climate, by="site")
#make temperature data ordinal and give levels
bc.df$meansummertemp <- factor(bc.df$meansummertemp)
levels(bc.df$meansummertemp)<- c("very low", "low","medium", "high")
```

-   Choose and fit a suitable model to find the relation a biomass and mean summer temperature.

```{r, warning=FALSE, message=FALSE}
#correlation
cor(bc$biomass, bc$meansummertemp, use="pairwise.complete.obs")
#test if the correlation is significant
cor.test(x=bc$biomass, y=bc$meansummertemp, use="pairwise.complete.obs")


#linear mixed effect model
fit1.lme <- lme(biomass~meansummertemp, random=~+1|site,  weights = varIdent(form = ~ +1|site), data=bc)
anova(fit1.lme, type="m")
summary(fit1.lme)


#linear model but predictor is converted to categorical
fit2.lm <-lm(biomass~meansummertemp,  data=bc.df)
anova(fit2.lm)
summary(fit2.lm)
#multiple comparison between the different groups
library(multcomp)
mcfit2 <- glht(fit2.lm, linfct=mcp(meansummertemp="Tukey"), data=bc.df)
summary(mcfit2)


#mugeneralised linear model
fit3.glm <- glm(biomass~poly(meansummertemp, 2), family=poisson,  data=bc)
anova(fit3.glm, test="Chi")
summary(fit3.glm) 
#we have overdispersion so we adjust the model
fit4.glm <- glm(biomass~poly(meansummertemp, 2), family=quasipoisson,  data=bc)
anova(fit3.glm, test="F")
summary(fit3.glm)
#Create a data frame with high resolution temp
# variable (from 6 to 12 with 0.1 steps):
predicted.df <- data.frame(temp = seq(6, 12, 0.1))
#Use the model to predict number of beers for these
# temp values:
predicted.df$biomass <- predict(fit4.glm, list(meansummertemp=predicted.df$temp),type='response')
#Finding optimum temperature:
filter(predicted.df,biomass==max(biomass))


library(MASS)
fit5.glmm <- glmmPQL(biomass~meansummertemp, random=~+1|site, family=quasipoisson, data=bc)
summary(fit5.glmm)


```

-   Check the model's assumptions are met.

```{r}
#Are the residuals well behaved?
#Is the response variable a reasonably linear function of the fitted values?
#Are the errors reasonably close to normally distributed?
residuals <- resid(fit1.lme)
plot(fitted(fit1.lme), residuals)
abline(0,0)
plot(fitted(fit1.lme), bc.df$biomass)
qqnorm(residuals)
qqline(residuals)

par(mfrow=c(2,2))
plot(fit2.lm)

par(mfrow=c(2,2))
plot(fit3.glm)

par(mfrow=c(2,2))
plot(fit4.glm)

```

-   Report key statistics from your model in a table or in the text.

-   Make a publication quality plot that shows the relationship between biomass and mean summer temperature.

```{r}

p1 <- ggplot(bc, aes( x=meansummertemp, y=biomass, colour=site, fill=site))+
      
      geom_boxplot()+
      
      stat_summary(fun=mean, geom="point", shape=21, size=6)+
      
      ylim(0, 150)+
  
      scale_colour_manual(values= c("#7570B3","#E7298A","#E6AB02", "#A6761D"), 
                          breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland")) +
      
      scale_fill_manual(values= alpha(c("#7570B3","#E7298A","#E6AB02", "#A6761D"), .3), 
                        breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland"))+
      
      ggtitle("Relationship between biomass and mean summer temperature in alpine grasslands")+
      
      labs(x="Mean Summer Temperature (C°)", y="Biomass (g·m)", col="Site", fill="Site")+
      
      theme_classic(base_size=16)+
      
      theme(plot.title = element_text(hjust = 0.41, size=16),
            
      axis.text.x = element_text(colour="black"), 
            
      axis.text.y = element_text(colour="black"), 
            
      legend.text = element_text(colour="black"),   
            
      panel.grid.minor.x= element_blank(), panel.grid.major.x=element_blank(),
            
      panel.grid.minor.y= element_blank(), panel.grid.major.y=element_blank(),
            
      strip.background=element_blank())
p1

p2 <- ggplot(bc.df, aes( x=meansummertemp, y=biomass, colour=site, fill=site))+
      
      geom_boxplot()+
  
      stat_summary(fun=mean, geom="point", shape=21, size=6)+
  
      ylim(0, 150)+
  
      scale_colour_manual(values= c("#7570B3","#E7298A","#E6AB02", "#A6761D"), 
                          breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland")) +
      
      scale_fill_manual(values= alpha(c("#7570B3","#E7298A","#E6AB02", "#A6761D"), .3), 
                        breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland"))+
      
      ggtitle("Relationship between biomass and mean summer temperature in alpine grasslands")+
      
      labs(x="Mean Summer Temperature (C°)", y="Biomass (g·m)", col="Site", fill="Site")+
      
      theme_classic(base_size=16)+
      
      theme(plot.title = element_text(hjust = 0.41, size=16),
            
      axis.text.x = element_text(colour="black"), 
            
      axis.text.y = element_text(colour="black"), 
            
      legend.text = element_text(colour="black"),   
            
      panel.grid.minor.x= element_blank(), panel.grid.major.x=element_blank(),
            
      panel.grid.minor.y= element_blank(), panel.grid.major.y=element_blank(),
            
      strip.background=element_blank())
p2


p3 <- ggplot(bc, aes( x=meansummertemp, y=biomass))+
      
      geom_line(data=predicted.df, aes(x=temp, y=biomass))+
    
      stat_summary(data=bc, fun=mean, geom="point", shape=21, size=6, aes(group=site, fill=site, colour=site))+
  
      ylim(0, 150)+
   
      scale_colour_manual(values= c("#7570B3","#E7298A","#E6AB02", "#A6761D"), 
                          breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland")) +
  
      scale_fill_manual(values= alpha(c("#7570B3","#E7298A","#E6AB02", "#A6761D"), .3), 
                        breaks = c("H", "A", "M", "L"), labels = c("High alpine", "Alpine", "Middle", "Lowland"))+
      
      ggtitle("Relationship between biomass and mean summer temperature in alpine grasslands")+
      
      labs(x="Mean Summer Temperature (C°)", y="Biomass (g·m)",  fill="Site", col="Site")+
      
      theme_classic(base_size=16)+
      
      theme(plot.title = element_text(hjust = 0.41, size=16),
            
      axis.text.x = element_text(colour="black"), 
            
      axis.text.y = element_text(colour="black"), 
            
      legend.text = element_text(colour="black"),   
            
      panel.grid.minor.x= element_blank(), panel.grid.major.x=element_blank(),
            
      panel.grid.minor.y= element_blank(), panel.grid.major.y=element_blank(),
            
      strip.background=element_blank())
p3

```

-   Write the statistical part of the methods and results sections of a manuscript describing the biomass-climate relationship. You should justify your choice of model.

-   Write a biological interpretation of your final model.

# References
